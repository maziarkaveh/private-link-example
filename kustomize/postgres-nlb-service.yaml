apiVersion: v1
kind: Service
metadata:
  name: postgres-nlb
  namespace: "{{ $sys.id }}"
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-internal: "true"
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internal"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    # Ensure the NLB gets the tags that Terraform will search for
    service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags: "omnistrate-instance={{ $sys.id }},omnistrate-service=postgres-nlb"
  labels:
    omnistrate-instance: "{{ $sys.id }}"
    omnistrate-service: "postgres-nlb"
    app: postgresql
spec:
  type: LoadBalancer
  ports:
    - port: 5432
      targetPort: 5432
      protocol: TCP
      name: postgresql
  selector:
    # Bitnami PostgreSQL chart uses these labels
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/instance: helm
    app.kubernetes.io/component: primary